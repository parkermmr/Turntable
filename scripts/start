#!/bin/bash
# Start all port-forwards in background, grouped under one process group

set -m

DETACHED=false
if [[ "$1" == "-d" ]]; then
  DETACHED=true
fi

start_forwards() {
  kubectl port-forward svc/activemq 8161:8161 61616:61616 &
  kubectl port-forward svc/kafbat 8080:8080 &
  kubectl port-forward svc/kafka 9092:9092 &
  kubectl port-forward svc/minio 9000:9000 9001:9001 &
  kubectl port-forward svc/nifi 8443:8443 &
  kubectl port-forward svc/opensearch 9200:9200 &
  kubectl port-forward svc/opensearch-dashboards 5601:5601 &
}

stop_forwards() {
  echo "Stopping all port-forwards..."
  kill $(pgrep -d " " -f "kubectl port-forward") 2>/dev/null
}

if $DETACHED; then
  echo "Starting all port-forwards detached..."
  start_forwards >/dev/null 2>&1
  echo "kubectl port-forward PIDs: $(pgrep -d ' ' -f 'kubectl port-forward')"
  echo "Use './stop' to stop them."
else
  echo "Starting all port-forwards interactively..."
  trap stop_forwards EXIT INT
  start_forwards
  echo "All port-forwards running. Press Ctrl+C to stop."
  wait
fi
