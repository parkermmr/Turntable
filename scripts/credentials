#!/bin/sh

nifi_pod=$(kubectl get pod | grep "nifi" | awk '{print $1}')
NIFI_USERNAME=$(kubectl logs $nifi_pod | grep -oP '(?<=Generated Username \[)[^]]*(?=\])')
NIFI_PASSWORD=$(kubectl logs $nifi_pod | grep -oP '(?<=Generated Password \[)[^]]*(?=\])')

MINIO_USERNAME="admin"
MINIO_PASSWORD="password"

ACTIVEMQ_USERNAME="admin"
ACTIVEMQ_PASSWORD="password"

OPENSEARCH_USERNAME="admin"
OPENSEARCH_PASSWORD='FunkyPass123!'

OUTPUT_FILE="./.env"
DO_ENV=false
DO_SAVE=false
DO_PRINT=false

print_help() {
  cat <<EOF
Usage: ${0##*/} [options]

Options:
  -e, --env            export credentials (if sourced) or print export lines
  -s, --save           save credentials to a .env file
  -o, --output <path>  path to save .env (default: ./ .env)
  -p, --print          print key=value pairs to stdout
  -h, --help           show this help
Examples:
  source ./credentials -e              # export into current shell
  eval "\$(./credentials -e)"           # import into current shell
  ./credentials -s -o /tmp/creds.env   # save to file
  ./credentials -p                     # print key=value to stdout
EOF
}

while [ $# -gt 0 ]; do
  case "$1" in
    -e|--env) DO_ENV=true; shift ;;
    -s|--save) DO_SAVE=true; shift ;;
    -p|--print) DO_PRINT=true; shift ;;
    -o|--output)
      OUTPUT_FILE="$2"
      shift 2
      ;;
    -h|--help) print_help; exit 0 ;;
    *) shift ;;
  esac
done

build_content() {
  printf 'NIFI_USERNAME=%s\n' "$NIFI_USERNAME"
  printf 'NIFI_PASSWORD=%s\n' "$NIFI_PASSWORD"
  printf 'MINIO_USERNAME=%s\n' "$MINIO_USERNAME"
  printf 'MINIO_PASSWORD=%s\n' "$MINIO_PASSWORD"
  printf 'ACTIVEMQ_USERNAME=%s\n' "$ACTIVEMQ_USERNAME"
  printf 'ACTIVEMQ_PASSWORD=%s\n' "$ACTIVEMQ_PASSWORD"
  printf 'OPENSEARCH_USERNAME=%s\n' "$OPENSEARCH_USERNAME"
  printf 'OPENSEARCH_PASSWORD=%s\n' "$OPENSEARCH_PASSWORD"
}

if $DO_SAVE; then
  mkdir -p "$(dirname -- "$OUTPUT_FILE")" 2>/dev/null || true
  build_content > "$OUTPUT_FILE"
  chmod 600 "$OUTPUT_FILE" 2>/dev/null || true
  printf 'Saved credentials to: %s\n' "$OUTPUT_FILE"
fi

single_quote() {
  printf %s "$1" | sed "s/'/'\\\\''/g; 1s/^/'/; \$s/\$/'/"
}

if $DO_ENV; then
    printf 'export NIFI_USERNAME=%s\n' "$(single_quote $NIFI_USERNAME)"
    printf 'export NIFI_PASSWORD=%s\n' "$(single_quote $NIFI_PASSWORD)"
    printf 'export MINIO_USERNAME=%s\n' "$(single_quote $MINIO_USERNAME)"
    printf 'export MINIO_PASSWORD=%s\n' "$(single_quote $MINIO_PASSWORD)"
    printf 'export ACTIVEMQ_USERNAME=%s\n' "$(single_quote $ACTIVEMQ_USERNAME)"
    printf 'export ACTIVEMQ_PASSWORD=%s\n' "$(single_quote $ACTIVEMQ_PASSWORD)"
    printf 'export OPENSEARCH_USERNAME=%s\n' "$(single_quote $OPENSEARCH_USERNAME)"
    printf "export OPENSEARCH_PASSWORD=%s\n" "$(single_quote $OPENSEARCH_PASSWORD)"
    printf '\nTo import: eval $(./scripts/%s --env)\n' "${0##*/}"
fi

if $DO_PRINT; then
  build_content
fi

if ! $DO_ENV && ! $DO_SAVE && ! $DO_PRINT; then
  print_help
fi